<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Login — Smart</title>
<style>
  body{font-family:Arial,system-ui;display:flex;align-items:center;justify-content:center;
    min-height:100vh;margin:0;background:linear-gradient(135deg,#2a5298,#1e3c72);color:#fff}
  .card{background:rgba(255,255,255,0.06);padding:20px;border-radius:12px;width:360px;box-shadow:0 6px 18px rgba(0,0,0,0.25)}
  input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.95);color:#111}
  button{width:100%;padding:10px;border-radius:8px;border:0;background:#4caf50;color:white;font-weight:700;cursor:pointer}
  .debug{margin-top:12px;font-size:13px;color:#ddd;background:rgba(0,0,0,0.15);padding:8px;border-radius:8px}
  ul{padding-left:18px;margin:8px 0}
</style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 10px 0;color:#fff">Login</h2>
    <input id="phone" placeholder="Phone (as registered)" />
    <input id="password" type="password" placeholder="Password" />
    <button id="btn">Login</button>
    <div id="msg" style="margin-top:10px;color:#ffdede"></div>

    <div class="debug" id="debug">
      <strong>Registered phones (debug):</strong>
      <div id="phones">loading…</div>
      <p style="margin:8px 0 0 0;font-size:12px;color:#cfe8ff">If your phone is listed but login fails, open the browser console (F12) to inspect the stored row object and keys.</p>
    </div>
  </div>

  <!-- bcryptjs for hash comparisons (used only if stored value looks like a bcrypt hash) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>

<script>
const SHEETY_URL = "https://api.sheety.co/4a9868f3c5ce48f976e575a769b00f1c/users/users";

// common fields we will check for a "password"
const POSSIBLE_PW_FIELDS = ['password','pass','passHash','passhash','pwd','secret','user_password','passwordHash','pw'];

async function fetchUsers() {
  try {
    const r = await fetch(SHEETY_URL);
    if (!r.ok) throw new Error('Sheety returned ' + r.status);
    const j = await r.json();
    const arr = Object.values(j).find(v => Array.isArray(v)) || [];
    console.log('Raw Sheety response:', j);
    return arr;
  } catch (err) {
    console.error('Fetch error:', err);
    document.getElementById('msg').textContent = 'Error fetching user list: ' + err.message;
    return [];
  }
}

async function showPhones() {
  const users = await fetchUsers();
  const phonesEl = document.getElementById('phones');
  if (!users.length) {
    phonesEl.innerHTML = '<em>No users in sheet yet.</em>';
    return;
  }
  const list = users.map(u => u.phone !== undefined ? String(u.phone) : JSON.stringify(u)).slice(0,50);
  phonesEl.innerHTML = '<ul>' + list.map(p => '<li>' + escapeHtml(p) + '</li>').join('') + '</ul>';
  console.log('Detected user objects (first 20):', users.slice(0,20));
  return users;
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function looksLikeBcryptHash(s) {
  return typeof s === 'string' && /^\$2[aby]\$/.test(s);
}

document.getElementById('btn').addEventListener('click', async () => {
  const phoneInput = document.getElementById('phone').value.trim();
  const passInput  = document.getElementById('password').value;
  const msg = document.getElementById('msg');
  msg.style.color = '#ffdede';
  msg.textContent = 'Checking...';

  const users = await fetchUsers();
  if (!users.length) {
    msg.textContent = 'No users found in sheet. Register first.';
    return;
  }

  // exact match first
  let found = users.find(u => String(u.phone) === phoneInput);

  // loose match (strip spaces and leading +) if exact not found
  if (!found) {
    const normalizedInput = phoneInput.replace(/\s+/g,'').replace(/^\+/, '');
    found = users.find(u => {
      if (!u.phone) return false;
      const p = String(u.phone).replace(/\s+/g,'').replace(/^\+/, '');
      return p === normalizedInput;
    });
  }

  if (!found) {
    msg.textContent = 'Phone not found. Check registered phones list below (or re-register).';
    return;
  }

  // show row keys to help debug
  const keys = Object.keys(found).filter(k => k !== 'id');
  console.log('Found user row:', found);
  // try to find a password-like field
  let matchedField = null;
  for (const f of POSSIBLE_PW_FIELDS) {
    if (f in found && found[f] !== undefined && String(found[f]).trim() !== '') {
      matchedField = f;
      break;
    }
  }

  if (!matchedField) {
    msg.textContent = 'User found but no password-like column present. See console for row keys: ' + JSON.stringify(keys);
    return;
  }

  const stored = found[matchedField];
  // if stored looks like bcrypt hash, compare with bcrypt
  if (looksLikeBcryptHash(stored)) {
    try {
      const ok = bcrypt.compareSync(passInput, stored);
      if (ok) {
        msg.style.color = '#b6f7c6';
        msg.textContent = '✅ Login successful (bcrypt match). Redirecting...';
        localStorage.setItem('loggedInUser', JSON.stringify({ phone: found.phone, id: found.id }));
        setTimeout(()=> window.location.href = 'dashboard.html', 800);
        return;
      } else {
        msg.textContent = 'Incorrect password (bcrypt mismatch). See console for row details.';
        console.log('Stored hash field:', matchedField, stored);
        return;
      }
    } catch (e) {
      console.error('bcrypt error', e);
      msg.textContent = 'Error verifying password hash.';
      return;
    }
  }

  // plain-text compare (only for demo/testing)
  if (String(stored) === passInput) {
    msg.style.color = '#b6f7c6';
    msg.textContent = '✅ Login successful. Redirecting...';
    localStorage.setItem('loggedInUser', JSON.stringify({ phone: found.phone, id: found.id }));
    setTimeout(()=> window.location.href = 'dashboard.html', 800);
    return;
  } else {
    msg.textContent = 'Incorrect password for this phone. Stored field used: "' + matchedField + '".';
    console.log('Found user row for debugging:', found);
    return;
  }
});

// show phones on load
showPhones();
</script>
</body>
</html>
